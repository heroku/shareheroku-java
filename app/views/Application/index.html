#{extends 'main.html' /}
#{set title:'Deploy a Git Repo on Heroku' /}
#{set 'moreStyles'}
<style type="text/css" media="screen">
    body {
        margin-top: 50px;
    }
    h3 {
        margin-left: 20px;
    }
    pre {
        margin-left: 20px;
    }
</style>
#{/set}
#{set 'moreScripts'}
<script type="text/javascript">

    $(function() {
        $('#createAppForm').submit(submitForm);

        $('#shareAppButton').attr("disabled", true);

        $("#emailAddress").keyup(function () {
            checkFormReady();
        });

        $("#customGitUrl").keyup(function () {
            checkFormReady();
        });
    });

    function checkFormReady() {
        if (($("#customGitUrl").val() != "") && ($("#emailAddress").val() != "") && (validateEmail($("#emailAddress").val()))) {
            $('#shareAppButton').attr("disabled", false);
            return true;
        }
        else {
            $('#shareAppButton').attr("disabled", true);
            return false;
        }
    }

    function submitForm(event) {
        event.preventDefault();
        
        if (checkFormReady()) {
            $('#createAppForm').children().attr("disabled", true);
            $('#createAppForm').fadeTo("slow", 0.35);
            $('#progressBar').show();
            $('#creatingApp').show();

            $.ajax("/", {
                type: 'POST',
                data: {
                    emailAddress: $('#emailAddress').val(),
                    gitUrl: $("#customGitUrl").val()
                },
                success: function(data, textStatus, jqXHR) {

                    if (data.result) {
                        $('#createAppForm').children().attr("disabled", false);
                        $('#createAppForm').hide();
                        $('#progressBar').hide();
                        $('#creatingApp').hide();
                        $('#appReady').show();

                        $('#step1').append('<h3><a href="'+ data.result.web_url + '">' + data.result.web_url + '</a></h3>');
                        $('#step7').append('<h3><a href="'+ data.result.web_url + '">' + data.result.web_url + '</a></h3>');

                        $('#step4Instructions').append('git clone -o heroku ' + data.result.git_url);
                    }
                    else if (data.error) {
                        reenableForm();

                        $.each(data.error, function(index, value) {
                            $("#errors").append(value + "<br/>");
                        });
                    }
                    else {
                        reenableForm();
                        window.alert("Unknown error occured " + data);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    reenableForm();
                    $("#errors").append(jqXHR);
                }

            });
        }
        else {
            reenableForm();
            $("#errors").append("Email address or Git URL not specified properly");
        }
    }

    function reenableForm() {
        $('#createAppForm').children().attr("disabled", false);
        $('#createAppForm').fadeTo("slow", 1);
        $('#progressBar').hide();
        $('#creatingApp').hide();
    }

    function validateEmail(email)
    {
        var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
        return email.match(re)
    }

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26859570-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>
#{/set}

<form id="createAppForm">
    <div id="errors" style="color: #ff0000">
    </div>
    
    <label>Git URL:</label>
    <input id="customGitUrl" type="text" placeholder="git://github.com/foo/bar.git" class="required" style="width: 300px;">

    <label>Email Address:</label>
    <input id="emailAddress" type="text" placeholder="foo@bar.com" class="required email">
    
    <br/>
    <button id="shareAppButton" type="submit" class="btn primary">Go!</button>
</form>

<img id="progressBar" src="@{'/public/images/progress.gif'}" style="display: none; top: 200px; left: 200px; position: absolute;"/>
<br/>

<div id="creatingApp" style="display: none;">

    <h1>Your app is being created!</h1>
    <br/>

    <div class="alert alert-info">
        Shortly you will receive an email that a new app has been shared with you.  If you haven't yet signed up for a Heroku account, you will be provided an account activation link.  Make sure your account has been activated before proceeding.
    </div>
</div>

<div id="appReady" style="display: none;">
    <h1>Your app is ready!</h1>
    <br/>
    <div id="step1">
        <h2>Step 1) Check out your app:</h2>
        <!-- link here -->
    </div>
    <div id="step2">
        <h2>Step 2) Setup your environment</h2>
        <h3>a) Install <a href="http://git-scm.com/download">git</a> (used to transfer the app to/from Heroku)</h3>
        <h3>b) Install the <a href="http://toolbelt.herokuapp.com">Heroku command line client</a></h3>
    </div>
    <div id="step3">
        <h2>Step 3) Login to Heroku from the command line:</h2>

        <pre>heroku login</pre>

        <div class="alert alert-info" style="margin-left: 20px;">
            The first time you login from the command line you will be instructed to setup an SSH key and pair it with your Heroku account.
        </div>
    </div>
    <div id="step4">
        <h2>Step 4) Copy the app from Heroku to your local machine:</h2>
        <pre id="step4Instructions"><!-- instructions go here --></pre>
    </div>
    <div id="step5">
        <h2>Step 5) Makes some changes to the app</h2>
    </div>
    <div id="step6">
        <h2>Step 6) Add the changes to git, commit them, and push the changes to Heroku:</h2>
        <pre>git add .
git commit -m "changed something"
git push heroku master</pre>
    </div>
    <div id="step7">
        <h2>Step 7) Check out your changes:</h2>
        <!-- link here -->
    </div>
    <div id="step8">
        <h2>Step 8) Keep learning by visiting the <a href="http://devcenter.heroku.com/">Heroku Dev Center</a></h2>
    </div>
</div>
